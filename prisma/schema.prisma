datasource db {
  provider = "sqlite"
}

generator client {
  provider = "prisma-client-js"
}

// --- suscripciones.prisma ---
model Suscripcion {
  id          String   @id @default(cuid())
  empresaId   String
  empresa     Empresa  @relation(fields: [empresaId], references: [id])
  planId      String
  plan        Plan     @relation(fields: [planId], references: [id])
  cuponId     String?
  cupon       Cupon?   @relation(fields: [cuponId], references: [id])
  fechaInicio DateTime
  fechaFin    DateTime
  estado      Estado   @default(ACTIVA)
  pagos       Pago[]
  createdAt   DateTime @default(now()) @map("creado_en")
  updatedAt   DateTime @updatedAt @map("actualizado_en")
}

model Plan {
  id            String        @id @default(cuid())
  nombre        String
  precioMensual Float
  descripcion   String?
  suscripciones Suscripcion[]
  createdAt     DateTime      @default(now()) @map("creado_en")
  updatedAt     DateTime      @updatedAt @map("actualizado_en")
  estado        Boolean       @default(true)
}

model Cupon {
  id              String        @id @default(cuid())
  codigo          String        @unique
  descuento       Float // Porcentaje de descuento (0-100)
  fechaExpiracion DateTime
  suscripciones   Suscripcion[]
  createdAt       DateTime      @default(now()) @map("creado_en")
  updatedAt       DateTime      @updatedAt @map("actualizado_en")
  estado          Boolean       @default(true)
}

enum Estado {
  ACTIVA
  CANCELADA
  EXPIRADA
}

// --- empresa.prisma ---
model Empresa {
  id            String        @id @default(cuid())
  nombre        String
  email         String        @unique
  telefono      String?
  direccion     String?
  sucursales    Sucursal[]
  suscripciones Suscripcion[] /* 
  tratamientos Tratamiento[] */
  createdAt     DateTime      @default(now()) @map("creado_en")
  updatedAt     DateTime      @updatedAt @map("actualizado_en")
  usuarios      Usuario[]
  tratamientos  Tratamiento[]
  consultas     Consulta[]
}

model Sucursal {
  id        String   @id @default(cuid())
  nombre    String
  direccion String?
  telefono  String?
  empresaId String
  empresa   Empresa  @relation(fields: [empresaId], references: [id])
  createdAt DateTime @default(now()) @map("creado_en")
  updatedAt DateTime @updatedAt @map("actualizado_en")
  citas     Cita[]
  estado        Boolean       @default(true)
}

// --- pago.prisma ---
model MetodoPago {
  id     String @id @default(cuid())
  nombre String @unique
  pagos  Pago[]
  estado        Boolean       @default(true)
}

model Pago {
  id            String      @id @default(cuid())
  suscripcionId String
  suscripcion   Suscripcion @relation(fields: [suscripcionId], references: [id])
  monto         Float
  moneda        String
  metodoPagoId  String      @map("metodo_pago_id")
  metodopago    MetodoPago  @relation(fields: [metodoPagoId], references: [id])
  usuarioId     String
  usuario       Usuario     @relation(fields: [usuarioId], references: [id])
  createdAt     DateTime    @default(now()) @map("creado_en")
  updatedAt     DateTime    @updatedAt @map("actualizado_en")
  estado        Boolean       @default(true)
}

model Usuario {
  id            String    @id @default(cuid())
  correo        String?   @unique
  nombre        String?
  emailVerified DateTime?
  imagen        String?
  contrase√±a   String?

  rolId String
  // rol   RolSistema @relation(fields: [rolId], references: [id])

  // Permisos personalizados (sobreescriben los del rol)
  // permisosUsuario PermisoUsuario[]
  pagos           Pago[]
  paciente        Paciente?
  cuentas         Cuenta[]
  // sesions         Sesion[]
  empresaId       String?
  empresa         Empresa?         @relation(fields: [empresaId], references: [id])
  rolSistema      RolSistema?      @relation(fields: [rolSistemaId], references: [id])
  rolSistemaId    String?
  permisoUsuarios PermisoUsuario[]
  sesions         Sesion[]
  estado        Boolean       @default(true)
}

// Modelos para permisos configurables
model Permiso {
  id              String           @id @default(cuid())
  nombre          String           @unique // Ej: "citas.crear"
  descripcion     String?
  modulo          String // Ej: "citas", "pacientes", "configuracion"
  accion          String // Ej: "crear", "leer", "actualizar", "eliminar"
  roles           RolPermiso[]
  permisoUsuarios PermisoUsuario[]
}

model RolSistema {
  id          String       @id @default(cuid())
  nombre      String       @unique // SUPER_ADMIN, DOCTOR, etc.
  descripcion String?
  nivel       Int          @default(0) // 0=Super Admin, 1=Admin, etc.
  permisos    RolPermiso[]
  usuarios    Usuario[]
}

model RolPermiso {
  id        String     @id @default(cuid())
  rolId     String
  permisoId String
  concedido Boolean    @default(true)
  rol       RolSistema @relation(fields: [rolId], references: [id])
  permiso   Permiso    @relation(fields: [permisoId], references: [id])

  @@unique([rolId, permisoId])
}

model PermisoUsuario {
  id        String  @id @default(cuid())
  usuarioId String
  permisoId String
  concedido Boolean @default(true)
  usuario   Usuario @relation(fields: [usuarioId], references: [id])
  permiso   Permiso @relation(fields: [permisoId], references: [id])

  @@unique([usuarioId, permisoId])
}

// Modificar Usuario para usar RolSistema
model Sesion {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  usuarioId    String
  expires      DateTime
  usuario      Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
}

model TokenVerificacion {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum Rol {
  SUPER_ADMIN
  ADMINISTRADOR
  DOCTOR
  ASISTENTE
  PACIENTE
}

model Paciente {
  id              String    @id @default(cuid())
  usuarioId       String    @unique
  fechaNacimiento DateTime?
  direccion       String?
  historialMedico String?
  telefono        String?

  usuario   Usuario    @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  consultas Consulta[]
  citas     Cita[]
}

model Cuenta {
  id                String  @id @default(cuid())
  usuarioId         String
  tipo              String
  proveedor         String
  idCuentaProveedor String
  tokenRefresco     String?
  tokenAcceso       String?
  expiraEn          Int?
  tipoToken         String?
  alcance           String?
  idToken           String?
  estadoSesion      String?

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
}

model Consulta {
  id                   String                @id @default(cuid())
  descripcion          String?
  fecha                DateTime
  pacienteId           String
  paciente             Paciente              @relation(fields: [pacienteId], references: [id])
  empresaId            String
  empresa              Empresa               @relation(fields: [empresaId], references: [id])
  createdAt            DateTime              @default(now()) @map("creado_en")
  updatedAt            DateTime              @updatedAt @map("actualizado_en")
  citas                Cita[]
  tratamientoConsultas TratamientoConsulta[]
  estado        Boolean       @default(true)
}

// --- citas.prisma ---
model Cita {
  id          String     @id @default(cuid())
  fecha       DateTime
  descripcion String?
  datos       String
  estado      EstadoCita @default(PENDIENTE)
  pacienteId  String
  paciente    Paciente   @relation(fields: [pacienteId], references: [id])
  sucursalId  String
  sucursal    Sucursal   @relation(fields: [sucursalId], references: [id])
  consultaId  String?
  consulta    Consulta?  @relation(fields: [consultaId], references: [id])
  createdAt   DateTime   @default(now()) @map("creado_en")
  updatedAt   DateTime   @updatedAt @map("actualizado_en")
}

enum EstadoCita {
  PENDIENTE
  CONFIRMADA
  CANCELADA
  COMPLETADA
}

model TratamientoConsulta {
  id             String      @id @default(cuid())
  tratamientoId  String
  tratamiento    Tratamiento @relation(fields: [tratamientoId], references: [id])
  consultaId     String
  consulta       Consulta    @relation(fields: [consultaId], references: [id])
  precioUnitario Float
  dienteId       String?

  createdAt DateTime @default(now()) @map("creado_en")
  updatedAt DateTime @updatedAt @map("actualizado_en")
}

model Diente {
  id          String   @id @default(cuid())
  numero      Int
  nombre      String
  descripcion String?
  createdAt   DateTime @default(now()) @map("creado_en")
  updatedAt   DateTime @updatedAt @map("actualizado_en")
}

// --- tratamientos.prisma ---
model Rama {
  id          String      @id @default(cuid())
  descripcion String
  categorias  Categoria[]
  createdAt   DateTime    @default(now()) @map("creado_en")
  updatedAt   DateTime    @updatedAt @map("actualizado_en")
  estado        Boolean       @default(true)
}

model Categoria {
  id           String        @id @default(cuid())
  nombre       String
  tratamientos Tratamiento[]
  ramaId       String
  rama         Rama          @relation(fields: [ramaId], references: [id])
  createdAt    DateTime      @default(now()) @map("creado_en")
  updatedAt    DateTime      @updatedAt @map("actualizado_en")
  estado        Boolean       @default(true)
}

model Tratamiento {
  id                   String                @id @default(cuid())
  nombre               String
  descripcion          String?
  precio               Float
  categoriaId          String
  categoria            Categoria             @relation(fields: [categoriaId], references: [id])
  empresaId            String
  empresa              Empresa               @relation(fields: [empresaId], references: [id])
  createdAt            DateTime              @default(now()) @map("creado_en")
  updatedAt            DateTime              @updatedAt @map("actualizado_en")
  tratamientoConsultas TratamientoConsulta[]
  estado        Boolean       @default(true)
}
